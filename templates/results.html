{% extends "base.html" %}

{% block title %}Voting Results{% endblock %}

{% block head %}
<style>
    /* Enhanced Results Page Styling */
    :root {
        --primary-color: #2563eb;
        --secondary-color: #10b981;
        --accent-color: #f59e0b;
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --background-light: #f3f4f6;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
        --gradient-blue: linear-gradient(135deg, #3b82f6, #1e40af);
        --gradient-green: linear-gradient(135deg, #10b981, #047857);
        --border-radius: 12px;
    }

    .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .results-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        padding-bottom: 1rem;
    }

    .results-header:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background: var(--gradient-blue);
        border-radius: 2px;
    }

    .results-header h1 {
        font-size: 2.5rem;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .results-header p {
        color: var(--text-light);
        font-size: 1.1rem;
    }

    .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--gradient-blue);
    }

    .stat-card.primary::before {
        background: var(--gradient-blue);
    }

    .stat-card.secondary::before {
        background: var(--gradient-green);
    }

    .stat-card.accent::before {
        background: var(--accent-color);
    }

    .stat-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-light);
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .stat-description {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .results-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .results-card-header {
        background: var(--gradient-blue);
        color: white;
        padding: 1.5rem;
        position: relative;
    }

    .results-card-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .results-card-body {
        padding: 1.5rem;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .results-table th {
        background-color: #f8fafc;
        color: var(--text-dark);
        font-weight: 600;
        text-align: left;
        padding: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .results-table td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
    }

    .results-table tr:hover {
        background-color: #f1f5f9;
    }

    .candidate-name {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .candidate-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }

    .party-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: #e2e8f0;
    }

    .party-badge.blue {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .party-badge.green {
        background-color: #d1fae5;
        color: #047857;
    }

    .party-badge.red {
        background-color: #fee2e2;
        color: #b91c1c;
    }

    .party-badge.yellow {
        background-color: #fef3c7;
        color: #92400e;
    }

    .party-badge.purple {
        background-color: #ede9fe;
        color: #5b21b6;
    }

    .result-bar-container {
        width: 100%;
        height: 24px;
        background-color: #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .result-bar {
        height: 100%;
        background: var(--gradient-blue);
        text-align: right;
        padding-right: 10px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        position: relative;
        transition: width 1s ease-out;
    }

    .result-percentage {
        font-weight: bold;
        font-size: 1.125rem;
        color: var(--text-dark);
    }

    .vote-count {
        font-weight: 600;
        color: var(--text-dark);
    }

    .chart-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .chart-card-header {
        background: var(--gradient-blue);
        color: white;
        padding: 1rem 1.5rem;
    }

    .chart-card-header h2 {
        margin: 0;
        font-size: 1.25rem;
    }

    .chart-card-body {
        padding: 1.5rem;
        height: 350px;
        position: relative;
    }

    .voting-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-dot.active {
        background-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .status-dot.closed {
        background-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
    }

    .status-text {
        font-weight: 600;
    }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
    }

    /* Animation */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .dashboard {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .chart-container {
            grid-template-columns: 1fr;
        }
        
        .results-table th, 
        .results-table td {
            padding: 0.75rem 0.5rem;
        }
        
        .candidate-avatar {
            width: 30px;
            height: 30px;
        }
        
        .stat-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-header">
        <h1>Election Results</h1>
        <p>Real-time vote tallying and election statistics</p>
    </div>

    <div class="voting-status">
        <div class="status-indicator">
            <div class="status-dot {% if total_votes > 0 %}active{% else %}closed{% endif %}"></div>
            <span class="status-text">Voting Status: {% if total_votes > 0 %}Active{% else %}No Votes Yet{% endif %}</span>
        </div>
        <div>
            Last updated: <span id="update-time">{{ now }}</span>
        </div>
    </div>

    <div class="dashboard">
        <div class="stat-card primary">
            <div class="stat-label">Total Votes Cast</div>
            <div class="stat-value">{{ total_votes }}</div>
            <div class="stat-description">Number of voters who have participated</div>
        </div>
        
        {% if results and total_votes > 0 %}
        <div class="stat-card secondary">
            <div class="stat-label">Leading Candidate</div>
            <div class="stat-value">{{ results[0].name }}</div>
            <div class="stat-description">Currently leading with {{ results[0].votes }} votes</div>
        </div>
        
        <div class="stat-card accent">
            <div class="stat-label">Voter Turnout</div>
            <div class="stat-value" id="voter-turnout">Calculating...</div>
            <div class="stat-description">Percentage of registered voters who voted</div>
        </div>
        {% endif %}
    </div>

    <div class="results-card">
        <div class="results-card-header">
            <h2>Detailed Results</h2>
        </div>
        <div class="results-card-body">
            {% if results %}
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Candidate</th>
                            <th>Party</th>
                            <th>Votes</th>
                            <th>Percentage</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                            <tr>
                                <td>
                                    <div class="candidate-name">
                                        <div class="candidate-avatar" style="background-color: {{ result.color|default('#3b82f6') }}">
                                            {{ result.name[:1] }}
                                        </div>
                                        <div>{{ result.name }}</div>
                                    </div>
                                </td>
                                <td>
                                    {% set color_classes = ['blue', 'green', 'red', 'yellow', 'purple'] %}
                                    <span class="party-badge {{ color_classes[loop.index0 % 5] }}">{{ result.party }}</span>
                                </td>
                                <td class="vote-count">{{ result.votes }}</td>
                                <td class="result-percentage">
                                    {% if total_votes > 0 %}
                                        {{ (result.votes / total_votes * 100) | round(2) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="result-bar-container">
                                        {% if total_votes > 0 %}
                                            <div class="result-bar" style="width: {{ (result.votes / total_votes * 100) }}%">
                                                {{ result.votes }}
                                            </div>
                                        {% else %}
                                            <div class="result-bar" style="width: 0%">0</div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div style="text-align: center; padding: 3rem 0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p style="color: var(--text-light); margin-top: 1rem;">No votes have been cast yet. Results will appear here once voting begins.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-card">
            <div class="chart-card-header">
                <h2>Vote Distribution</h2>
            </div>
            <div class="chart-card-body">
                <canvas id="results-pie-chart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-card-header">
                <h2>Comparative Analysis</h2>
            </div>
            <div class="chart-card-body">
                <canvas id="results-bar-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="results-card">
        <div class="results-card-header">
            <h2>Election Timeline</h2>
        </div>
        <div class="results-card-body">
            <canvas id="results-timeline-chart" height="100"></canvas>
        </div>
    </div>
</div>

<div class="card">
    <h2>Election Results</h2>
    
    {% if total_votes > 0 %}
        <p>Total votes cast: {{ total_votes }}</p>
        
        <table class="results-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Candidate</th>
                    <th>Party</th>
                    <th>Position</th>
                    <th>Votes</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            {% if candidate.image_path %}
                                <img src="{{ url_for('static', filename='candidate_images/' + candidate.image_path) }}" alt="{{ candidate.name }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            {% endif %}
                            {{ candidate.name }}
                        </td>
                        <td>{{ candidate.party }}</td>
                        <td>{{ candidate.position }}</td>
                        <td>{{ candidate.vote_count }}</td>
                        <td>{{ "%.2f"|format(candidate.vote_count / total_votes * 100) }}%</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No votes have been cast yet.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update the current time
        const updateTime = document.getElementById('update-time');
        updateTime.textContent = moment().format('MMMM D, YYYY [at] h:mm:ss A');
        
        // Set a dummy voter turnout (in a real app, you'd calculate this)
        const voterTurnout = document.getElementById('voter-turnout');
        if (voterTurnout) {
            // This would come from the server in a real application
            const totalRegisteredVoters = {{ total_votes + 20 }};
            const turnoutPercentage = {{ total_votes }} / totalRegisteredVoters * 100;
            voterTurnout.textContent = turnoutPercentage.toFixed(1) + '%';
        }
        
        // Extract data from template directly instead of using JSON.parse
        {% if results %}
        const candidateNames = [{% for result in results %}'{{ result.name }}', {% endfor %}];
        const votes = [{% for result in results %}{{ result.votes }}, {% endfor %}];
        const parties = [{% for result in results %}'{{ result.party }}', {% endfor %}];
        const totalVotes = {{ total_votes }};
        {% else %}
        const candidateNames = [];
        const votes = [];
        const parties = [];
        const totalVotes = 0;
        {% endif %}
        
        // Generate colors for the candidates
        const colorPalette = [
            '#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6',
            '#06b6d4', '#ec4899', '#d97706', '#6366f1', '#059669'
        ];
        
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(colorPalette[i % colorPalette.length]);
            }
            return colors;
        }
        
        // Create the pie chart
        if (totalVotes > 0 && document.getElementById('results-pie-chart')) {
            const backgroundColors = generateColors(candidateNames.length);
            
            const ctx = document.getElementById('results-pie-chart').getContext('2d');
            const pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: candidateNames,
                    datasets: [{
                        data: votes,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = (value / totalVotes * 100).toFixed(1);
                                    return `${context.label}: ${value} votes (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }
        
        // Create the bar chart for comparative analysis
        if (totalVotes > 0 && document.getElementById('results-bar-chart')) {
            const backgroundColors = generateColors(candidateNames.length);
            
            const ctx = document.getElementById('results-bar-chart').getContext('2d');
            const barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: candidateNames,
                    datasets: [{
                        label: 'Votes',
                        data: votes,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = (value / totalVotes * 100).toFixed(1);
                                    return `${value} votes (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Votes',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Candidates',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Create a timeline chart (simulated data for visualization)
        if (document.getElementById('results-timeline-chart')) {
            // Generate some timeline data (this would come from server in real app)
            const timeLabels = [];
            const now = new Date();
            for (let i = 12; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 30 * 60000); // Every 30 minutes
                timeLabels.push(time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            }
            
            // Create simulated vote count data points
            const timelineDatasets = [];
            
            if (candidateNames && candidateNames.length > 0) {
                candidateNames.forEach((candidateName, index) => {
                    // Generate progressive vote data (increasing over time)
                    const voteData = [];
                    const finalVotes = votes[index];
                    const growthPatterns = [
                        [0.1, 0.2, 0.3, 0.35, 0.4, 0.5, 0.6, 0.7, 0.75, 0.85, 0.9, 0.95, 1.0], // steady growth
                        [0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.6, 0.7, 0.8, 0.9, 0.95, 0.98, 1.0], // late surge
                        [0.2, 0.35, 0.4, 0.5, 0.55, 0.6, 0.65, 0.7, 0.8, 0.85, 0.9, 0.95, 1.0], // early lead
                        [0.1, 0.25, 0.3, 0.4, 0.45, 0.5, 0.6, 0.65, 0.7, 0.8, 0.9, 0.95, 1.0]  // mid surge
                    ];
                    
                    const pattern = growthPatterns[index % growthPatterns.length];
                    pattern.forEach(ratio => {
                        voteData.push(Math.round(finalVotes * ratio));
                    });
                    
                    timelineDatasets.push({
                        label: candidateName,
                        data: voteData,
                        borderColor: colorPalette[index % colorPalette.length],
                        backgroundColor: `${colorPalette[index % colorPalette.length]}22`, // Add transparency
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    });
                });
            } else {
                // If no votes yet, show empty timeline
                timelineDatasets.push({
                    label: 'No votes yet',
                    data: Array(timeLabels.length).fill(0),
                    borderColor: '#d1d5db',
                    backgroundColor: '#f3f4f6',
                    fill: true
                });
            }
            
            const ctx = document.getElementById('results-timeline-chart').getContext('2d');
            const timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: timelineDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Time: ${tooltipItems[0].label}`;
                                }
                            }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Votes',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Animate the result bars
        const resultBars = document.querySelectorAll('.result-bar');
        resultBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 300);
        });
        
        // Auto-refresh results every 60 seconds
        setInterval(function() {
            // In a real app, you'd make an AJAX call to get fresh data
            // For this demo, we'll just update the time
            updateTime.textContent = moment().format('MMMM D, YYYY [at] h:mm:ss A');
        }, 60000);
    });
</script>
{% endblock %}